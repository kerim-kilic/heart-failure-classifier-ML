---
title: "heart-failure-classifier"
author: "Kerim Kilic"
date: "6/5/2022"
output: html_document
---

# Library

This markdown uses the **tidymodels** and **janitor** libraries.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidymodels)
library(janitor)
```

# Dataset descriptive analytics and data split

```{r}
heart_failure_data <- read.csv("heart_failure_clinical_records_dataset.csv") %>%
  clean_names()
heart_failure_data %>% glimpse()
```

Turn nominal predictors into factors.

```{r}
heart_failure_data <- heart_failure_data %>% 
  mutate_at(c("anaemia","diabetes","high_blood_pressure","sex","smoking", "death_event"), as.character) 
heart_failure_data <- heart_failure_data %>%
  mutate(anaemia = factor(anaemia, levels = c("1", "0")),
         diabetes = factor(diabetes, levels = c("1", "0")),
         high_blood_pressure = factor(high_blood_pressure, levels = c("1", "0")),
         sex = factor(sex, levels = c("1", "0")),
         smoking = factor(smoking, levels = c("1", "0")),
         death_event = factor(death_event, levels = c("1", "0")))
```

Set the seed and split the data in train and test set.

```{r}
set.seed(2022)
heart_failure_split <- initial_split(heart_failure_data, prop = 0.8, strata = "death_event")
```

# Recipe

```{r}
my_recipe <- training(heart_failure_split) %>%
  recipe(death_event ~ .) %>%
  step_string2factor(all_nominal_predictors()) %>%
  step_corr(all_numeric_predictors()) %>%
  step_nzv(all_predictors()) %>%
  step_center(all_numeric_predictors()) %>%
  step_scale(all_numeric_predictors())

my_recipe
```

Glimpse into all the variables of the recipe.

```{r}
my_recipe %>% prep() %>% juice() %>% glimpse()
```

# Creating models

## Logistic regression

```{r}
glm <- logistic_reg(mode = "classification") %>%
  set_engine("glm")
```

# Testing the models

## Metric sets and folds

```{r}
#class_metrics <- metric_set(accuracy, precision, recall)
```

Defining the number of folds for the cross validation to 4 and keeping repeats at 1 to minimize the time to train each model.

```{r}
folds <- vfold_cv(training(heart_failure_split), v = 4)
```

## Cross validation logistic regression model

```{r}
glm_wf <- workflow() %>%
  add_recipe(my_recipe) %>%
  add_model(glm) %>%
  fit(training(heart_failure_split))

glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  conf_mat(truth = death_event, estimate = .pred_class)

glm_accuracy <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  accuracy(estimate = .pred_class, truth = death_event)

glm_sensitivity <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  sensitivity(estimate = .pred_class, truth = death_event)

glm_specificity <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  specificity(estimate = .pred_class, truth = death_event)

glm_precision <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  precision(estimate = .pred_class, truth = death_event)

glm_recall <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  precision(estimate = .pred_class, truth = death_event)

glm_f_score <- glm_wf %>%
  predict(training(heart_failure_split)) %>%
  bind_cols(training(heart_failure_split)) %>%
  f_meas(estimate = .pred_class, truth = death_event)

# F1 Score = 2*(Recall * Precision) / (Recall + Precision)
```

- Accuracy = `r round(glm_accuracy$.estimate[1],3)` 
- sensitivity = `r round(glm_sensitivity$.estimate[1],3)` 
- specificity = `r round(glm_specificity$.estimate[1],3)`
- precision = `r round(glm_precision$.estimate[1],3)`
- recall = `r round(glm_recall$.estimate[1],3)`
- F score = `r round(glm_f_score$.estimate[1],3)`